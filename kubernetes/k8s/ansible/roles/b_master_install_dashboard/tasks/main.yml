---

- name: Copy file from local to remote (dashboard.yaml)
  copy:
    src: "./configs/dashboard.yaml"  # Local path
    dest: "{{ SHARED_FOLDER_VM }}/configs/dashboard.yaml"
    owner: 1000
    group: 1000

- name: Apply dashboard.yaml
  command: 'kubectl apply -f {{ SHARED_FOLDER_VM }}/configs/dashboard.yaml'
  become: no

- name: Copy file from local to remote (dashboard_service_account.yml)
  copy:
    src: "./configs/dashboard_service_account.yml"  # Local path
    dest: "{{ SHARED_FOLDER_VM }}/configs/dashboard_service_account.yml"
    owner: 1000
    group: 1000

- name: Apply dashboard_service_account.yml
  command: 'kubectl apply -f {{ SHARED_FOLDER_VM }}/configs/dashboard_service_account.yml'
  become: no


- name: Copy from local to remote (dashboard_cluster_role_binding.yml)
  copy:
    src: "./configs/dashboard_cluster_role_binding.yml"  # Local path
    dest: "{{ SHARED_FOLDER_VM }}/configs/dashboard_cluster_role_binding.yml"
    owner: 1000
    group: 1000

- name: Apply  dashboard_cluster_role_binding.yml
  command: 'kubectl apply -f {{ SHARED_FOLDER_VM }}/configs/dashboard_cluster_role_binding.yml'
  become: no


- name: Copy from local to remote (dashboard_long_lived_token.yml)
  copy:
    src: "./configs/dashboard_long_lived_token.yml"  # Local path
    dest: "{{ SHARED_FOLDER_VM }}/configs/dashboard_long_lived_token.yml"
    owner: 1000
    group: 1000

- name: Apply dashboard_long_lived_token.yml
  command: 'kubectl apply -f {{ SHARED_FOLDER_VM }}/configs/dashboard_long_lived_token.yml'
  become: no


- name: Extract  Bearer token
  command: 'kubectl -n kubernetes-dashboard create token admin-user'  
  register: bearer_token
  become: no

- name: Show bearer_token
  debug:
    var: bearer_token

- name: Touch a file, using symbolic modes to set the permissions (equivalent to 0644)
  file:
    path: "{{ SHARED_FOLDER_VM }}/configs/bearer_token.out"
    state: touch
    mode: "0644"

- name: Copy join command using inline content
  copy:
    content: "{{ bearer_token.stdout_lines | last | trim }}"
    dest: "{{ SHARED_FOLDER_VM }}/configs/bearer_token.out"


- name: Fetch desde el host remoto
  fetch:
    src: "{{ SHARED_FOLDER_VM }}/configs/bearer_token.out"
    dest: "./configs/" # Local path
    flat: yes 


- name: Debug dashboard
  debug:
    msg: "Now you can access to dashboard on https://{{ IP_SECTIONS }}{{ (IP_START | int + item | int) }}:30001, check the admin token at ansible/configs/bearer_token.out"
  with_sequence: start=1 end="{{ (NUM_WORKER_NODES | int) }}"
 

